<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JGitRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mavanagaiata</a> &gt; <a href="index.source.html" class="el_package">com.github.koraktor.mavanagaiata.git.jgit</a> &gt; <span class="el_source">JGitRepository.java</span></div><h1>JGitRepository.java</h1><pre class="source lang-java linenums">/*
 * This code is free software; you can redistribute it and/or modify it under
 * the terms of the new BSD License.
 *
 * Copyright (c) 2012-2020, Sebastian Staudt
 *               2015, Kay Hannay
 */

package com.github.koraktor.mavanagaiata.git.jgit;

import java.io.File;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.eclipse.jgit.api.DescribeCommand;
import org.eclipse.jgit.api.Git;
import org.eclipse.jgit.api.errors.GitAPIException;
import org.eclipse.jgit.errors.IncorrectObjectTypeException;
import org.eclipse.jgit.errors.MissingObjectException;
import org.eclipse.jgit.errors.RevWalkException;
import org.eclipse.jgit.lib.IndexDiff;
import org.eclipse.jgit.lib.ObjectId;
import org.eclipse.jgit.lib.ObjectReader;
import org.eclipse.jgit.lib.Ref;
import org.eclipse.jgit.lib.Repository;
import org.eclipse.jgit.revwalk.RevCommit;
import org.eclipse.jgit.revwalk.RevObject;
import org.eclipse.jgit.revwalk.RevTag;
import org.eclipse.jgit.revwalk.RevWalk;
import org.eclipse.jgit.storage.file.FileRepositoryBuilder;
import org.eclipse.jgit.treewalk.FileTreeIterator;

import com.github.koraktor.mavanagaiata.git.AbstractGitRepository;
import com.github.koraktor.mavanagaiata.git.CommitWalkAction;
import com.github.koraktor.mavanagaiata.git.GitCommit;
import com.github.koraktor.mavanagaiata.git.GitRepositoryException;
import com.github.koraktor.mavanagaiata.git.GitTag;
import com.github.koraktor.mavanagaiata.git.GitTagDescription;

import static java.nio.charset.StandardCharsets.*;
import static org.apache.commons.io.FileUtils.*;
import static org.eclipse.jgit.lib.Constants.*;

/**
 * Wrapper around JGit's {@link Repository} object to represent a Git
 * repository
 *
 * @author Sebastian Staudt
 */
public class JGitRepository extends AbstractGitRepository {

    static final String COMMONDIR_FILE = &quot;commondir&quot;;
<span class="fc" id="L56">    static final Pattern DESCRIBE_PATTERN = Pattern.compile(&quot;(.*)-([1-9][0-9]*)-g([0-9a-f]+)$&quot;);</span>
    static final String GITDIR_FILE = &quot;gitdir&quot;;
    private static final String INDEX_FILE = &quot;index&quot;;
    static final String REF_LINK_PREFIX = &quot;ref: &quot;;

    private boolean checked;
    Repository repository;
    RevCommit headCommit;
    ObjectId headObject;

    /**
     * Creates a new empty instance
     */
<span class="fc" id="L69">    JGitRepository() {}</span>

    /**
     * Creates a new instance for the given worktree and or Git directory
     *
     * @param workTree The worktree of the repository or {@code null}
     * @param gitDir The GIT_DIR of the repository or {@code null}
     * @param headRef The ref to use as {@code HEAD}
     * @throws GitRepositoryException if the parameters do not match a Git
     *         repository
     */
    public JGitRepository(File workTree, File gitDir, String headRef)
<span class="fc" id="L81">            throws GitRepositoryException {</span>
<span class="fc" id="L82">        this.headRef = headRef;</span>

<span class="fc" id="L84">        buildRepository(workTree, gitDir);</span>
<span class="fc" id="L85">    }</span>

    final void buildRepository(File workTree, File gitDir) throws GitRepositoryException {
<span class="fc bfc" id="L88" title="All 4 branches covered.">        if (gitDir == null &amp;&amp; workTree == null) {</span>
<span class="fc" id="L89">            throw new GitRepositoryException(&quot;Neither worktree nor GIT_DIR is set.&quot;);</span>
        } else {
<span class="fc bfc" id="L91" title="All 4 branches covered.">            if (workTree != null &amp;&amp; !workTree.exists()) {</span>
<span class="fc" id="L92">                throw new GitRepositoryException(&quot;The worktree &quot; + workTree + &quot; does not exist&quot;);</span>
            }
<span class="fc bfc" id="L94" title="All 4 branches covered.">            if (gitDir != null &amp;&amp; !gitDir.exists()) {</span>
<span class="fc" id="L95">                throw new GitRepositoryException(&quot;The GIT_DIR &quot; + gitDir + &quot; does not exist&quot;);</span>
            }
        }

<span class="fc" id="L99">        FileRepositoryBuilder repositoryBuilder = getRepositoryBuilder();</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (gitDir == null) {</span>
<span class="fc" id="L101">            resolveGitDir(workTree, repositoryBuilder);</span>
        } else {
<span class="fc" id="L103">            repositoryBuilder.setGitDir(gitDir);</span>
<span class="fc" id="L104">            repositoryBuilder.setWorkTree(workTree);</span>
        }

        try {
<span class="fc" id="L108">            repository = repositoryBuilder.build();</span>
<span class="fc" id="L109">        } catch (IOException e) {</span>
<span class="fc" id="L110">            throw new GitRepositoryException(&quot;Could not initialize repository&quot;, e);</span>
<span class="fc" id="L111">        }</span>
<span class="fc" id="L112">    }</span>

    @Override
    public void check() throws GitRepositoryException {
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (!repository.getObjectDatabase().exists()) {</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">            File path = repository.isBare() ? repository.getDirectory() : repository.getWorkTree();</span>
<span class="fc" id="L118">            throw new GitRepositoryException(path.getAbsolutePath() + &quot; is not a Git repository.&quot;);</span>
        }

<span class="fc" id="L121">        checked = true;</span>
<span class="fc" id="L122">    }</span>

    /**
     * {@inheritDoc}
     * &lt;p&gt;
     * Closes JGit's repository instance.
     *
     * @see Repository#close
     */
    @Override
    public void close() {
<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (repository != null) {</span>
<span class="fc" id="L134">            repository.close();</span>
<span class="fc" id="L135">            repository = null;</span>
        }
<span class="fc" id="L137">    }</span>

    @Override
    public GitTagDescription describe() throws GitRepositoryException {
<span class="fc" id="L141">        DescribeCommand command = getDescribeCommand();</span>

        try {
<span class="fc" id="L144">            command.setTarget(getHeadObject());</span>

            String abbrev;
            int distance;
            String tagName;

<span class="fc" id="L150">            String describe = command.call();</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">            if (describe == null) {</span>
<span class="fc" id="L152">                abbrev = getAbbreviatedCommitId(getHeadCommit());</span>
<span class="fc" id="L153">                distance = -1;</span>
<span class="fc" id="L154">                tagName = null;</span>
            } else {
<span class="fc" id="L156">                Matcher describeMatcher = DESCRIBE_PATTERN.matcher(describe);</span>

<span class="fc bfc" id="L158" title="All 2 branches covered.">                if (describeMatcher.matches()) {</span>
<span class="fc" id="L159">                    abbrev = describeMatcher.group(3);</span>
<span class="fc" id="L160">                    distance = Integer.parseInt(describeMatcher.group(2));</span>
<span class="fc" id="L161">                    tagName = describeMatcher.group(1);</span>
                } else {
<span class="fc" id="L163">                    abbrev = null;</span>
<span class="fc" id="L164">                    distance = 0;</span>
<span class="fc" id="L165">                    tagName = describe;</span>
                }
            }

<span class="fc" id="L169">            return new GitTagDescription(abbrev, tagName, distance);</span>
<span class="nc" id="L170">        } catch (IOException | GitAPIException e) {</span>
<span class="nc" id="L171">            throw new GitRepositoryException(e.getMessage());</span>
        }
    }

    @Override
    public String getHeadRef() {
<span class="fc" id="L177">        return headRef;</span>
    }

    @Override
    public String getAbbreviatedCommitId(GitCommit commit) throws GitRepositoryException {
<span class="fc" id="L182">        try (ObjectReader objectReader = repository.getObjectDatabase().newReader()) {</span>
<span class="fc" id="L183">            return objectReader.abbreviate(((JGitCommit) commit).commit).name();</span>
<span class="fc" id="L184">        } catch (IOException e) {</span>
<span class="fc" id="L185">            throw new GitRepositoryException(</span>
<span class="fc" id="L186">                String.format(&quot;Commit \&quot;%s\&quot; could not be abbreviated.&quot;, commit.getId()),</span>
                e);
        }
    }

    @Override
    public String getBranch() throws GitRepositoryException {
        try {
<span class="fc" id="L194">            Ref ref = repository.getRefDatabase().findRef(headRef);</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">            return ref == null ? null : Repository.shortenRefName(ref.getTarget().getName());</span>
<span class="fc" id="L196">        } catch (IOException e) {</span>
<span class="fc" id="L197">            throw new GitRepositoryException(&quot;Current branch could not be read.&quot;, e);</span>
        }
    }

    DescribeCommand getDescribeCommand() {
<span class="nc" id="L202">        return Git.wrap(repository).describe();</span>
    }

    @Override
    public JGitCommit getHeadCommit() throws GitRepositoryException {
<span class="fc" id="L207">        return new JGitCommit(getHeadRevCommit());</span>
    }

    /**
     * Creates a new JGit {@code IndexDiff} instance for this repository and
     * worktree
     *
     * @return A new index diff
     * @throws GitRepositoryException if the {@code HEAD} object cannot be
     *         resolved
     * @throws IOException if the index diff cannot be created
     */
    IndexDiff createIndexDiff() throws GitRepositoryException, IOException {
<span class="nc" id="L220">        FileTreeIterator workTreeIterator = new FileTreeIterator(repository);</span>
<span class="nc" id="L221">        return new IndexDiff(repository, getHeadObject(), workTreeIterator);</span>
    }

    /**
     * Creates a new JGit {@code FileRepositoryBuilder} instance
     *
     * @return A new repository builder
     */
    FileRepositoryBuilder getRepositoryBuilder() {
<span class="fc" id="L230">        return new FileRepositoryBuilder().readEnvironment();</span>
    }

    @Override
    public Map&lt;String, GitTag&gt; getTags()
            throws GitRepositoryException {
<span class="fc" id="L236">        Map&lt;String, GitTag&gt; tags = new HashMap&lt;&gt;();</span>

<span class="fc" id="L238">        try (RevWalk revWalk = getRevWalk()) {</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">            for (Ref tag : repository.getRefDatabase().getRefsByPrefix(R_TAGS)) {</span>
                try {
<span class="fc" id="L241">                    RevTag revTag = revWalk.lookupTag(tag.getObjectId());</span>
<span class="fc" id="L242">                    RevObject object = revWalk.peel(revTag);</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">                    if (object instanceof RevCommit) {</span>
<span class="fc" id="L244">                        tags.put(object.getName(), new JGitTag(revTag));</span>
                    }
<span class="fc" id="L246">                } catch (IncorrectObjectTypeException | MissingObjectException ignored) {</span>
                    // Ignore lightweight tags or tags on missing objects
<span class="fc" id="L248">                }</span>
<span class="fc" id="L249">            }</span>
<span class="nc" id="L250">        } catch (IOException e) {</span>
<span class="nc" id="L251">            throw new GitRepositoryException(&quot;The tags could not be resolved.&quot;, e);</span>
<span class="fc" id="L252">        }</span>

<span class="fc" id="L254">        return tags;</span>
    }

    public File getWorkTree() {
<span class="fc" id="L258">        return repository.getWorkTree();</span>
    }

    @Override
    public boolean isChecked() {
<span class="fc" id="L263">        return checked;</span>
    }

    @Override
    public boolean isDirty(boolean ignoreUntracked) throws GitRepositoryException {
        try {
<span class="fc" id="L269">            IndexDiff indexDiff = createIndexDiff();</span>
<span class="fc" id="L270">            indexDiff.diff();</span>

<span class="fc bfc" id="L272" title="All 4 branches covered.">            return !ignoreUntracked &amp;&amp; !indexDiff.getUntracked().isEmpty() ||</span>
<span class="pc bpc" id="L273" title="1 of 4 branches missed.">                !(indexDiff.getAdded().isEmpty() &amp;&amp; indexDiff.getChanged().isEmpty() &amp;&amp;</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">                    indexDiff.getRemoved().isEmpty() &amp;&amp;</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">                    indexDiff.getMissing().isEmpty() &amp;&amp;</span>
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">                    indexDiff.getModified().isEmpty() &amp;&amp;</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">                    indexDiff.getConflicting().isEmpty());</span>
<span class="fc" id="L278">        } catch (IOException e) {</span>
<span class="fc" id="L279">            throw new GitRepositoryException(&quot;Could not create repository diff.&quot;, e);</span>
        }
    }

    @Override
    public boolean isOnUnbornBranch() throws GitRepositoryException {
<span class="fc" id="L285">        return getHeadObject().equals(ObjectId.zeroId());</span>
    }

    @Override
    public void loadTag(GitTag tag) throws GitRepositoryException {
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">        if (tag.isLoaded()) {</span>
<span class="nc" id="L291">            return;</span>
        }

<span class="fc" id="L294">        JGitTag jgitTag = (JGitTag) tag;</span>

<span class="fc" id="L296">        try (RevWalk revWalk = getRevWalk()) {</span>
<span class="fc" id="L297">            revWalk.parseBody(jgitTag.tag);</span>
<span class="fc" id="L298">            jgitTag.taggerIdent = jgitTag.tag.getTaggerIdent();</span>
<span class="nc" id="L299">        } catch (IOException e) {</span>
<span class="nc" id="L300">            throw new GitRepositoryException(&quot;Failed to load tag meta data.&quot;, e);</span>
        } finally {
<span class="fc" id="L302">            jgitTag.tag.disposeBody();</span>
        }
<span class="fc" id="L304">    }</span>

    @Override
    public void walkCommits(CommitWalkAction action)
            throws GitRepositoryException {
<span class="fc" id="L309">        try (RevWalk revWalk = getRevWalk()) {</span>
<span class="fc" id="L310">            revWalk.markStart(getHeadRevCommit());</span>

<span class="fc bfc" id="L312" title="All 2 branches covered.">            for (RevCommit commit : revWalk) {</span>
<span class="fc" id="L313">                action.execute(new JGitCommit(commit));</span>
<span class="fc" id="L314">            }</span>
<span class="nc" id="L315">        } catch (IOException | RevWalkException e) {</span>
<span class="nc" id="L316">            throw new GitRepositoryException(&quot;Could not walk commits.&quot;, e);</span>
<span class="fc" id="L317">        }</span>
<span class="fc" id="L318">    }</span>

    /**
     * Returns a commit object for {@code HEAD}
     *
     * @return The commit object for {@code HEAD}
     * @see RevCommit
     * @throws GitRepositoryException if the commit object cannot be retrieved
     */
    RevCommit getHeadRevCommit() throws GitRepositoryException {
<span class="fc bfc" id="L328" title="All 2 branches covered.">        if (headCommit != null) {</span>
<span class="fc" id="L329">            return headCommit;</span>
        }

        try {
<span class="fc" id="L333">            headCommit = repository.parseCommit(getHeadObject());</span>
<span class="fc" id="L334">            return headCommit;</span>
<span class="nc" id="L335">        } catch (IOException e) {</span>
<span class="nc" id="L336">            throw new GitRepositoryException(</span>
<span class="nc" id="L337">                    String.format(&quot;Commit \&quot;%s\&quot; could not be loaded.&quot;,</span>
<span class="nc" id="L338">                        getHeadObject().getName()), e);</span>
        }
    }

    /**
     * Returns the object for the Git ref currently set as {@code HEAD}
     *
     * @return The currently selected {@code HEAD} object
     * @throws GitRepositoryException if the ref cannot be resolved
     */
    ObjectId getHeadObject() throws GitRepositoryException {
<span class="fc bfc" id="L349" title="All 2 branches covered.">        if (headObject == null) {</span>
            try {
<span class="fc" id="L351">                headObject = repository.resolve(headRef);</span>
<span class="fc" id="L352">            } catch (IOException e) {</span>
<span class="fc" id="L353">                throw new GitRepositoryException(</span>
<span class="fc" id="L354">                    String.format(&quot;Ref \&quot;%s\&quot; could not be resolved.&quot;, headRef),</span>
                    e);
<span class="fc" id="L356">            }</span>
        }

<span class="fc bfc" id="L359" title="All 2 branches covered.">        if (headObject == null) {</span>
<span class="fc" id="L360">            headObject = ObjectId.zeroId();</span>
        }

<span class="fc" id="L363">        return headObject;</span>
    }

    /**
     * @return A new JGit {@code RevWalk} instance for this repository
     */
    RevWalk getRevWalk() {
<span class="nc" id="L370">        return new RevWalk(repository);</span>
    }

    private void resolveGitDir(File workTree, FileRepositoryBuilder repositoryBuilder) throws GitRepositoryException {
<span class="fc" id="L374">        File foundGitDir = repositoryBuilder.findGitDir(workTree).getGitDir();</span>
<span class="fc bfc" id="L375" title="All 2 branches covered.">        if (foundGitDir == null) {</span>
<span class="fc" id="L376">            throw new GitRepositoryException(workTree + &quot; is not inside a Git repository. Please specify the GIT_DIR separately.&quot;);</span>
        }

        try {
<span class="fc bfc" id="L380" title="All 2 branches covered.">            if (directoryContains(workTree, foundGitDir)) {</span>
<span class="fc" id="L381">                repositoryBuilder.setGitDir(foundGitDir);</span>
<span class="fc" id="L382">                repositoryBuilder.setWorkTree(workTree);</span>
            } else {
<span class="fc" id="L384">                resolveLinkedWorkTree(workTree, foundGitDir, repositoryBuilder);</span>
            }
<span class="nc" id="L386">        } catch (IOException e) {</span>
<span class="nc" id="L387">            throw new GitRepositoryException(&quot;Failure while resolving GIT_DIR.&quot;, e);</span>
<span class="fc" id="L388">        }</span>
<span class="fc" id="L389">    }</span>

    private void resolveLinkedWorkTree(File workTree, File foundGitDir, FileRepositoryBuilder repositoryBuilder) throws IOException {
<span class="fc bfc" id="L392" title="All 2 branches covered.">        if (directoryContains(foundGitDir.getParentFile(), workTree)) {</span>
<span class="fc" id="L393">            repositoryBuilder.setGitDir(foundGitDir);</span>
<span class="fc" id="L394">            repositoryBuilder.setWorkTree(foundGitDir.getParentFile());</span>
        } else {
<span class="fc" id="L396">            File commonDir = new File(foundGitDir, COMMONDIR_FILE);</span>
<span class="fc" id="L397">            String realGitDirPath = readFileToString(commonDir, UTF_8).trim();</span>

<span class="fc" id="L399">            File realGitDir = new File(foundGitDir, realGitDirPath);</span>
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">            if (!realGitDir.exists()) {</span>
<span class="fc" id="L401">                realGitDir = new File(realGitDirPath);</span>
            }

<span class="fc" id="L404">            File originalGitDirFile = new File(foundGitDir, GITDIR_FILE);</span>
<span class="fc" id="L405">            String originalGitDirPath = readFileToString(originalGitDirFile, UTF_8).trim();</span>
<span class="fc" id="L406">            File originalGitDir = new File(originalGitDirPath);</span>

<span class="pc bpc" id="L408" title="2 of 4 branches missed.">            if (originalGitDir.exists() &amp;&amp; realGitDir.exists()) {</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">                if (headRef.equals(HEAD)) {</span>
<span class="fc" id="L410">                    File headFile = new File(foundGitDir, HEAD);</span>
<span class="fc" id="L411">                    String rawHead = readFileToString(headFile, UTF_8);</span>
<span class="fc" id="L412">                    headRef = rawHead.trim().replaceFirst(REF_LINK_PREFIX, &quot;&quot;);</span>
                }

<span class="fc" id="L415">                repositoryBuilder.setGitDir(realGitDir);</span>
<span class="fc" id="L416">                repositoryBuilder.setIndexFile(new File(foundGitDir, INDEX_FILE));</span>
<span class="fc" id="L417">                repositoryBuilder.setWorkTree(originalGitDir.getParentFile());</span>
            }
        }
<span class="fc" id="L420">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>