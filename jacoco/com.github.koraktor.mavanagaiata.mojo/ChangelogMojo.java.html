<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ChangelogMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mavanagaiata</a> &gt; <a href="index.source.html" class="el_package">com.github.koraktor.mavanagaiata.mojo</a> &gt; <span class="el_source">ChangelogMojo.java</span></div><h1>ChangelogMojo.java</h1><pre class="source lang-java linenums">/*
 * This code is free software; you can redistribute it and/or modify it under
 * the terms of the new BSD License.
 *
 * Copyright (c) 2011-2019, Sebastian Staudt
 *               2016, Jeff Kreska
 */

package com.github.koraktor.mavanagaiata.mojo;

import java.io.File;
import java.util.Map;
import java.util.regex.Pattern;

import org.apache.maven.plugins.annotations.LifecyclePhase;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;

import com.github.koraktor.mavanagaiata.git.CommitWalkAction;
import com.github.koraktor.mavanagaiata.git.GitRepository;
import com.github.koraktor.mavanagaiata.git.GitRepositoryException;
import com.github.koraktor.mavanagaiata.git.GitTag;

import static org.apache.commons.lang3.StringUtils.*;

/**
 * This goal allows to generate a changelog of the currently checked out branch
 * of the Git repository. It will use information from tags and commit messages
 * to build a reverse chronological summary of the development. It can be
 * configured to display the changelog or save it to a file.
 *
 * @author Sebastian Staudt
 * @since 0.2.0
 */
@Mojo(name = &quot;changelog&quot;,
      defaultPhase = LifecyclePhase.PROCESS_RESOURCES,
      threadSafe = true)
<span class="fc" id="L38">public class ChangelogMojo extends AbstractGitOutputMojo {</span>

    /**
     * Pre-defined base URLs used for links
     */
<span class="fc" id="L43">    enum LinkToBaseUrl {</span>
<span class="fc" id="L44">        GITHUB(&quot;https://github.com/%s/%s&quot;),</span>
<span class="fc" id="L45">        GITLAB(&quot;https://gitlab.com/%s/%s&quot;);</span>

        private final String baseUrl;

<span class="fc" id="L49">        LinkToBaseUrl(String baseUrl) {</span>
<span class="fc" id="L50">            this.baseUrl = baseUrl;</span>
<span class="fc" id="L51">        }</span>
    }

    /**
     * The format to use while generating the changelog
     *
     * @see #formatTemplate
     * @since 0.9.0
     */
    @Parameter(property = &quot;mavanagaiata.changelog.format&quot;)
    protected ChangelogFormat format;

    /**
     * The formatting template to use while generating the changelog
     * &lt;p&gt;
     * This may be one of {@code DEFAULT} or {@code MARKDOWN}.
     * &lt;p&gt;
     * Individual attributes may be overridden using {@link #format}.
     *
     * @since 0.9.0
     */
    @Parameter(property = &quot;mavanagaiata.changelog.formatTemplate&quot;,
               defaultValue = &quot;DEFAULT&quot;)
    ChangelogFormat.Formats formatTemplate;

    /**
     * The project name for GitHub links
     *
     * @since 0.9.0
     */
    @Parameter(property = &quot;mavanagaiata.changelog.linkToProject&quot;)
    String linkToProject;

    /**
     * The user name for GitHub links
     *
     * @since 0.9.0
     */
    @Parameter(property = &quot;mavanagaiata.changelog.linkToUser&quot;)
    String linkToUser;

    /**
     * Used to select the service to create links to
     * &lt;p&gt;
     * {@code GITHUB} and {@code GITLAB} are available.
     *
     * @since 0.9.0
     */
    @Parameter(property = &quot;mavanagaiata.changelog.linkTo&quot;,
               defaultValue = &quot;GITHUB&quot;)
    LinkToBaseUrl linkTo;

    /**
     * Can be used to override the pre-defined URLs from {@link #linkTo} with
     * a customized URL
     *
     * @since 0.9.0
     */
    @Parameter(property = &quot;mavanagaiata.changelog.linkToBaseUrl&quot;)
    String linkToBaseUrl;

    /**
     * The file to write the changelog to
     *
     * @since 0.4.1
     */
    @Parameter(property = &quot;mavanagaiata.changelog.outputFile&quot;)
    protected File outputFile;

    /**
     * Whether to skip merge commitsâ€™ messages
     *
     * @since 0.9.0
     */
    @Parameter(property = &quot;mavanagaiata.changelog.skipMergeCommits&quot;,
               defaultValue = &quot;true&quot;)
    boolean skipMergeCommits;

    /**
     * Whether to skip tagged commits' messages
     * &lt;br&gt;
     * This is useful when usually tagging commits like &quot;Version bump to X.Y.Z&quot;
     */
    @Parameter(property = &quot;mavanagaiata.changelog.skipTagged&quot;,
               defaultValue = &quot;false&quot;)
    boolean skipTagged;

    /**
     * Whether to skip commits that match the given regular expression
     *
     * @since 0.8.0
     */
    @Parameter(property = &quot;mavanagaiata.changelog.skipCommitsMatching&quot;)
    String skipCommitsMatching;

    private Pattern skipCommitsPattern;

    /**
     * Walks through the history of the currently checked out branch of the
     * Git repository and builds a changelog from the commits contained in that
     * branch.
     *
     * @throws MavanagaiataMojoException if retrieving information from the Git
     *         repository fails
     */
    @Override
    protected void writeOutput(GitRepository repository)
            throws MavanagaiataMojoException {
        try {
<span class="fc" id="L160">            format.printStream = printStream;</span>
<span class="fc" id="L161">            format.printHeader();</span>

<span class="fc" id="L163">            ChangelogWalkAction action = new ChangelogWalkAction(repository);</span>
<span class="fc" id="L164">            action.currentRef = repository.getBranch();</span>
<span class="fc" id="L165">            repository.walkCommits(action);</span>

<span class="fc" id="L167">            format.printSeparator();</span>
<span class="fc" id="L168">            format.printCompareLink(action.currentRef, null, action.currentRef.equals(repository.getBranch()));</span>
<span class="fc" id="L169">        } catch (GitRepositoryException e) {</span>
<span class="fc" id="L170">            throw MavanagaiataMojoException.create(&quot;Unable to generate changelog from Git&quot;, e);</span>
<span class="fc" id="L171">        }</span>
<span class="fc" id="L172">    }</span>

    /**
     * Returns the output file for the generated changelog
     *
     * @return The output file for the generated changelog
     */
    @Override
    public File getOutputFile() {
<span class="nc" id="L181">        return outputFile;</span>
    }

    @Override
    protected void initConfiguration() {
<span class="fc" id="L186">        super.initConfiguration();</span>

<span class="fc" id="L188">        format = formatTemplate.getFormat().apply(format);</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">        if (format.dateFormat == null) {</span>
<span class="fc" id="L190">            format.dateFormat = dateFormat;</span>
        }
<span class="fc" id="L192">        format.prepare();</span>

<span class="pc bpc" id="L194" title="1 of 4 branches missed.">        if (isNotBlank(linkToUser) &amp;&amp; isNotBlank(linkToProject)) {</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">            String baseUrl = isNotBlank(linkToBaseUrl) ? linkToBaseUrl : linkTo.baseUrl;</span>
<span class="fc" id="L196">            format.enableCreateLinks(String.format(baseUrl, linkToUser, linkToProject));</span>
        }

<span class="pc bpc" id="L199" title="1 of 4 branches missed.">        if (skipCommitsMatching != null &amp;&amp; !skipCommitsMatching.isEmpty()) {</span>
<span class="fc" id="L200">            skipCommitsPattern = Pattern.compile(skipCommitsMatching, Pattern.MULTILINE);</span>
        }
<span class="fc" id="L202">    }</span>

    /**
     * Sets the output file for the generated changelog
     *
     * @param outputFile The output file for the generated changelog
     */
    public void setOutputFile(File outputFile) {
<span class="nc" id="L210">        this.outputFile = outputFile;</span>
<span class="nc" id="L211">    }</span>

    class ChangelogWalkAction extends CommitWalkAction {

        private String currentRef;
<span class="fc" id="L216">        private boolean firstCommit = true;</span>
        private GitRepository repository;
        private Map&lt;String, GitTag&gt; tags;

<span class="fc" id="L220">        ChangelogWalkAction(GitRepository repository) throws GitRepositoryException {</span>
<span class="fc" id="L221">            this.repository = repository;</span>
<span class="fc" id="L222">            tags = repository.getTags();</span>
<span class="fc" id="L223">        }</span>

        protected void run() throws GitRepositoryException {
<span class="fc bfc" id="L226" title="All 4 branches covered.">            if (skipCommitsPattern != null &amp;&amp; skipCommitsPattern.matcher(currentCommit.getMessage()).find()) {</span>
<span class="fc" id="L227">                return;</span>
            }

<span class="pc bpc" id="L230" title="3 of 4 branches missed.">            if (skipMergeCommits &amp;&amp; currentCommit.isMergeCommit()) {</span>
<span class="nc" id="L231">                return;</span>
            }

<span class="fc" id="L234">            boolean firstLine = firstCommit;</span>
<span class="fc" id="L235">            firstCommit = false;</span>

<span class="fc bfc" id="L237" title="All 2 branches covered.">            if (tags.containsKey(currentCommit.getId())) {</span>
<span class="fc" id="L238">                String lastRef = currentRef;</span>
<span class="fc" id="L239">                GitTag currentTag = tags.get(currentCommit.getId());</span>
<span class="fc" id="L240">                currentRef = currentTag.getName();</span>

<span class="fc" id="L242">                format.printSeparator();</span>

<span class="fc bfc" id="L244" title="All 2 branches covered.">                if (!firstLine) {</span>
<span class="fc" id="L245">                    format.printCompareLink(currentRef, lastRef, lastRef.equals(repository.getBranch()));</span>
                }

<span class="fc" id="L248">                repository.loadTag(currentTag);</span>
<span class="fc" id="L249">                format.printTag(currentTag);</span>

<span class="fc bfc" id="L251" title="All 2 branches covered.">                if (skipTagged) {</span>
<span class="fc" id="L252">                    return;</span>
                }
<span class="fc bfc" id="L254" title="All 2 branches covered.">            } else if (firstLine) {</span>
<span class="fc" id="L255">                format.printBranch(repository.getBranch());</span>
            }

<span class="fc" id="L258">            format.printCommit(currentCommit);</span>
<span class="fc" id="L259">        }</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>