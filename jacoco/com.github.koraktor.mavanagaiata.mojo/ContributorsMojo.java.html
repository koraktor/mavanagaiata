<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContributorsMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mavanagaiata</a> &gt; <a href="index.source.html" class="el_package">com.github.koraktor.mavanagaiata.mojo</a> &gt; <span class="el_source">ContributorsMojo.java</span></div><h1>ContributorsMojo.java</h1><pre class="source lang-java linenums">/*
 * This code is free software; you can redistribute it and/or modify it under
 * the terms of the new BSD License.
 *
 * Copyright (c) 2011-2019, Sebastian Staudt
 */

package com.github.koraktor.mavanagaiata.mojo;

import java.io.File;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.text.translate.CharSequenceTranslator;
import org.apache.commons.text.translate.LookupTranslator;
import org.apache.maven.plugins.annotations.LifecyclePhase;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;

import com.github.koraktor.mavanagaiata.git.CommitWalkAction;
import com.github.koraktor.mavanagaiata.git.GitCommit;
import com.github.koraktor.mavanagaiata.git.GitRepository;
import com.github.koraktor.mavanagaiata.git.GitRepositoryException;
import com.github.koraktor.mavanagaiata.git.MailMap;

import static java.util.Comparator.*;
import static org.apache.commons.lang3.StringUtils.*;
import static org.apache.commons.text.StringEscapeUtils.*;

/**
 * This goal allows to generate a list of contributors for the currently
 * checked out branch of the Git repository. It will list all authors of the
 * commits in this branch. It can be configured to display the changelog or
 * save it to a file.
 *
 * @author Sebastian Staudt
 * @since 0.2.0
 */
@Mojo(name = &quot;contributors&quot;,
      defaultPhase = LifecyclePhase.PROCESS_RESOURCES,
      threadSafe = true)
<span class="fc" id="L45">public class ContributorsMojo extends AbstractGitOutputMojo {</span>

<span class="fc" id="L47">    private static final Map&lt;CharSequence, CharSequence&gt; MARKDOWN_TRANSLATION_MAP = new HashMap&lt;&gt;();</span>
    static {
<span class="fc" id="L49">        MARKDOWN_TRANSLATION_MAP.put(&quot;[&quot;, &quot;\\[&quot;);</span>
<span class="fc" id="L50">        MARKDOWN_TRANSLATION_MAP.put(&quot;]&quot;, &quot;\\]&quot;);</span>
    }

<span class="fc" id="L53">    private static final CharSequenceTranslator MARKDOWN_TRANSLATOR = new LookupTranslator(MARKDOWN_TRANSLATION_MAP);</span>

    /**
     * The string to prepend to every contributor name
     */
    @Parameter(property = &quot;mavanagaiata.contributors.contributorPrefix&quot;,
               defaultValue = &quot; * &quot;)
    String contributorPrefix;

    @Parameter(property = &quot;mavanagaiata.contributors.escapeHtml&quot;,
               defaultValue = &quot;false&quot;)
    boolean escapeHtml;

    @Parameter(property = &quot;mavanagaiata.contributors.escapeMarkdown&quot;,
               defaultValue = &quot;false&quot;)
    boolean escapeMarkdown;

    /**
     * The header to print above the changelog
     */
    @Parameter(property = &quot;mavanagaiata.contributors.header&quot;,
               defaultValue = &quot;Contributors\n============\n&quot;)
    String header;

    private MailMap mailMap;

    /**
     * The file to write the contributors list to
     */
    @Parameter(property = &quot;mavanagaiata.contributors.outputFile&quot;)
    File outputFile;

    /**
     * Whether the number of contributions should be listed
     */
    @Parameter(property = &quot;mavanagaiata.contributors.showCounts&quot;,
               defaultValue = &quot;true&quot;)
    boolean showCounts;

    /**
     * Whether the email addresses of contributors should be listed
     */
    @Parameter(property = &quot;mavanagaiata.contributors.showEmail&quot;,
               defaultValue = &quot;false&quot;)
    boolean showEmail;

    /**
     * The method used to sort contributors
     * &lt;p&gt;
     * Available values are {@code count}, {@code date} and {@code name}.
     */
    @Parameter(property = &quot;mavanagaiata.contributors.sort&quot;,
               defaultValue = &quot;count&quot;)
    String sort;

    /**
     * Selects the attribute to use for sorting contributors
     */
    @Override
    protected void initConfiguration() {
<span class="fc" id="L113">        contributorPrefix = unescapeFormatNewlines(contributorPrefix);</span>
<span class="fc" id="L114">        header            = unescapeFormatNewlines(header);</span>

<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (!equalsAnyIgnoreCase(sort, &quot;date&quot;, &quot;name&quot;)) {</span>
<span class="fc" id="L117">            sort = &quot;count&quot;;</span>
        }

<span class="fc" id="L120">        super.initConfiguration();</span>
<span class="fc" id="L121">    }</span>

    /**
     * Walks through the history of the currently checked out branch of the
     * Git repository and builds a list of contributors from the authors of the
     * commits.
     *
     * @throws MavanagaiataMojoException if retrieving information from the Git
     *         repository fails
     */
    @Override
    protected void writeOutput(GitRepository repository)
            throws MavanagaiataMojoException {
        try {
<span class="fc" id="L135">            mailMap = repository.getMailMap();</span>

<span class="fc" id="L137">            ContributorsWalkAction action = new ContributorsWalkAction();</span>
<span class="fc" id="L138">            repository.walkCommits(action);</span>

<span class="fc" id="L140">            List&lt;Contributor&gt; contributors = action.getContributors();</span>
<span class="fc bfc" id="L141" title="All 3 branches covered.">            switch (sort) {</span>
                case &quot;date&quot;:
<span class="fc" id="L143">                    contributors.sort(comparing(Contributor::getFirstCommitDate));</span>
<span class="fc" id="L144">                    break;</span>
                case &quot;name&quot;:
<span class="fc" id="L146">                    contributors.sort(comparing(Contributor::getName));</span>
<span class="fc" id="L147">                    break;</span>
                default:
<span class="fc" id="L149">                    contributors.sort(comparing(Contributor::getCount).reversed());</span>
            }

<span class="fc" id="L152">            printStream.println(header);</span>

<span class="fc bfc" id="L154" title="All 2 branches covered.">            for (Contributor contributor : contributors) {</span>
<span class="fc" id="L155">                printStream.print(contributorPrefix + escapeName(contributor.name));</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">                if (showEmail) {</span>
<span class="fc" id="L157">                    printStream.print(&quot; (&quot; + contributor.emailAddress + &quot;)&quot;);</span>
                }
<span class="fc bfc" id="L159" title="All 2 branches covered.">                if (showCounts) {</span>
<span class="fc" id="L160">                    printStream.print(&quot; (&quot; + contributor.count + &quot;)&quot;);</span>
                }
<span class="fc" id="L162">                printStream.println();</span>
<span class="fc" id="L163">            }</span>
<span class="fc" id="L164">        } catch (GitRepositoryException e) {</span>
<span class="fc" id="L165">            throw MavanagaiataMojoException.create(&quot;Unable to read contributors from Git&quot;, e);</span>
<span class="fc" id="L166">        }</span>
<span class="fc" id="L167">    }</span>

    /**
     * Returns an escaped form of the contributor name
     * &lt;p&gt;
     * Depending on the {@link #escapeHtml} and {@link #escapeMarkdown} fields
     * this methods escapes HTML tags and/or Markdown link brackets.
     *
     * @param name The name of the contributor
     * @return An escaped form of the contributor
     */
    private String escapeName(String name) {
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (escapeHtml) {</span>
<span class="fc" id="L180">            name = escapeHtml4(name);</span>
        }

<span class="fc bfc" id="L183" title="All 2 branches covered.">        if (escapeMarkdown) {</span>
<span class="fc" id="L184">            name = MARKDOWN_TRANSLATOR.translate(name);</span>
        }

<span class="fc" id="L187">        return name;</span>
    }

    /**
     * Returns the output file for the generated contributors list
     *
     * @return The output file for the generated contributors list
     */
    public File getOutputFile() {
<span class="nc" id="L196">        return outputFile;</span>
    }

    /**
     * Sets the output file for the generated contributors list
     *
     * @param outputFile The output file for the generated contributors list
     */
    public void setOutputFile(File outputFile) {
<span class="nc" id="L205">        this.outputFile = outputFile;</span>
<span class="nc" id="L206">    }</span>

<span class="fc" id="L208">    class ContributorsWalkAction extends CommitWalkAction {</span>

<span class="fc" id="L210">        HashMap&lt;String, Contributor&gt; contributors = new HashMap&lt;&gt;();</span>

        List&lt;Contributor&gt; getContributors() {
<span class="fc" id="L213">            return new ArrayList&lt;&gt;(contributors.values());</span>
        }

        protected void run() {
<span class="fc" id="L217">            String emailAddress = mailMap.getCanonicalAuthorEmailAddress(currentCommit);</span>
<span class="fc" id="L218">            Contributor contributor = contributors.get(emailAddress);</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">            if (contributor == null) {</span>
<span class="fc" id="L220">                contributors.put(emailAddress, new Contributor(currentCommit));</span>
            } else {
<span class="fc" id="L222">                contributor.addCommit(currentCommit);</span>
            }
<span class="fc" id="L224">        }</span>
    }

    class Contributor {

<span class="fc" id="L229">        Integer count = 1;</span>
        String emailAddress;
        Date firstCommitDate;
        String name;

<span class="fc" id="L234">        Contributor(GitCommit commit) {</span>
<span class="fc" id="L235">            firstCommitDate = commit.getAuthorDate();</span>

<span class="pc bpc" id="L237" title="1 of 2 branches missed.">            if (ContributorsMojo.this.mailMap.exists()) {</span>
<span class="nc" id="L238">                emailAddress = ContributorsMojo.this.mailMap.getCanonicalAuthorEmailAddress(commit);</span>
<span class="nc" id="L239">                name = ContributorsMojo.this.mailMap.getCanonicalAuthorName(commit);</span>
            } else {
<span class="fc" id="L241">                emailAddress = commit.getAuthorEmailAddress();</span>
<span class="fc" id="L242">                name = commit.getAuthorName();</span>
            }
<span class="fc" id="L244">        }</span>

        void addCommit(GitCommit commit) {
<span class="fc" id="L247">            count ++;</span>

<span class="pc bpc" id="L249" title="1 of 2 branches missed.">            if (commit.getAuthorDate().before(firstCommitDate)) {</span>
<span class="nc" id="L250">                firstCommitDate = commit.getAuthorDate();</span>
            }
<span class="fc" id="L252">        }</span>

        Integer getCount() {
<span class="fc" id="L255">            return count;</span>
        }

        Date getFirstCommitDate() {
<span class="fc" id="L259">            return firstCommitDate;</span>
        }

        String getName() {
<span class="fc" id="L263">            return name;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>