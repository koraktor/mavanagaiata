<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InfoClassMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Mavanagaiata</a> &gt; <a href="index.source.html" class="el_package">com.github.koraktor.mavanagaiata.mojo</a> &gt; <span class="el_source">InfoClassMojo.java</span></div><h1>InfoClassMojo.java</h1><pre class="source lang-java linenums">/*
 * This code is free software; you can redistribute it and/or modify it under
 * the terms of the new BSD License.
 *
 * Copyright (c) 2012-2022, Sebastian Staudt
 */

package com.github.koraktor.mavanagaiata.mojo;

import org.codehaus.plexus.interpolation.InterpolatorFilterReader;
import org.codehaus.plexus.interpolation.MapBasedValueSource;
import org.codehaus.plexus.interpolation.RegexBasedInterpolator;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.Reader;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

import org.apache.commons.io.IOUtils;
import org.apache.maven.plugins.annotations.Component;
import org.apache.maven.plugins.annotations.LifecyclePhase;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.apache.maven.shared.filtering.FilterWrapper;
import org.apache.maven.shared.filtering.MavenFileFilter;
import org.apache.maven.shared.filtering.MavenFilteringException;

import com.github.koraktor.mavanagaiata.git.GitRepository;
import com.github.koraktor.mavanagaiata.git.GitRepositoryException;
import com.github.koraktor.mavanagaiata.git.GitTagDescription;

import static java.nio.file.Files.*;
import static java.util.Collections.*;
import static org.apache.commons.io.FileUtils.*;

/**
 * This goal generates the source code for a Java class with Git information
 * like commit ID and tag name.
 *
 * @author Sebastian Staudt
 * @since 0.5.0
 */
@Mojo(name = &quot;info-class&quot;,
      defaultPhase = LifecyclePhase.GENERATE_SOURCES,
      threadSafe = true)
<span class="fc" id="L52">public class InfoClassMojo extends AbstractGitMojo {</span>

    private static final String BUILTIN_TEMPLATE_PATH = &quot;TemplateGitInfoClass.java&quot;;

    /**
     * The name of the class to generate
     */
    @Parameter(property = &quot;mavanagaiata.info-class.className&quot;,
               defaultValue = &quot;GitInfo&quot;)
    String className;

    /**
     * The encoding of the generated source file
     */
    @Parameter(property = &quot;mavanagaiata.info-class.encoding&quot;,
               defaultValue = &quot;${project.build.sourceEncoding}&quot;)
    String encoding;

    @Component
    MavenFileFilter fileFilter;

    /**
     * The name of the package in which the class will be generated
     */
    @Parameter(property = &quot;mavanagaiata.info-class.packageName&quot;,
               defaultValue = &quot;${project.groupId}.${project.artifactId}&quot;)
    String packageName;

    /**
     * The directory to write the source code to
     * &lt;p&gt;
     * This directory is automatically added to the source roots used to
     * compile the project.
     */
    @Parameter(property = &quot;mavanagaiata.info-class.outputDirectory&quot;,
               defaultValue = &quot;${project.build.directory}/generated-sources/mavanagaiata&quot;)
    File outputDirectory;

    /**
     * The path to an alternative template for the info class
     */
    @Parameter(property = &quot;mavanagaiata.info-class.templatePath&quot;)
    private File templateFile;

    /**
     * Returns an input stream for the template source file for the info class
     * &lt;p&gt;
     * This may either be the builtin template or an arbitrary source file set
     * via {@code templatePath}.
     *
     * @return An input stream for the template source file
     * @throws FileNotFoundException if the template source cannot be found
     */
    InputStream getTemplateSource() throws IOException {
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">        if (templateFile == null) {</span>
<span class="fc" id="L107">            return getClass().getResourceAsStream(BUILTIN_TEMPLATE_PATH);</span>
        } else {
<span class="nc" id="L109">            return newInputStream(templateFile.toPath());</span>
        }
    }

    /**
     * Generates a info class filled providing information of the Git
     * repository
     *
     * @throws MavanagaiataMojoException if the info class cannot be generated
     */
    @Override
    public void run(GitRepository repository) throws MavanagaiataMojoException {
<span class="fc" id="L121">        addProperty(&quot;info-class.className&quot;, className);</span>
<span class="fc" id="L122">        addProperty(&quot;info-class.packageName&quot;, packageName);</span>

        try {
<span class="fc" id="L125">            File sourceFile = copyTemporaryTemplate();</span>
<span class="fc" id="L126">            writeSourceFile(repository, sourceFile);</span>
<span class="fc" id="L127">        } catch (GitRepositoryException e) {</span>
<span class="fc" id="L128">            throw MavanagaiataMojoException.create(&quot;Could not get all information from repository&quot;, e);</span>
<span class="fc" id="L129">        } catch (IOException | MavenFilteringException e) {</span>
<span class="fc" id="L130">            throw MavanagaiataMojoException.create(&quot;Could not create info class source&quot;, e);</span>
<span class="fc" id="L131">        }</span>

<span class="fc" id="L133">        project.addCompileSourceRoot(outputDirectory.getAbsolutePath());</span>
<span class="fc" id="L134">    }</span>

    private File copyTemporaryTemplate()
            throws IOException, MavanagaiataMojoException {
<span class="fc" id="L138">        try (InputStream templateStream = getTemplateSource()) {</span>
            File tempSourceDir;
            try {
<span class="fc" id="L141">                tempSourceDir = createTempDirectory(&quot;mavanagaita-info-class&quot;).toFile();</span>
<span class="nc" id="L142">            } catch (IOException e) {</span>
<span class="nc" id="L143">                throw MavanagaiataMojoException.create(&quot;Could not create temporary directory&quot;, e);</span>
<span class="fc" id="L144">            }</span>
<span class="fc" id="L145">            forceDeleteOnExit(tempSourceDir);</span>
<span class="fc" id="L146">            String sourceFileName = className + &quot;.java&quot;;</span>
<span class="fc" id="L147">            File tempSourceFile = new File(tempSourceDir, sourceFileName);</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">            if (!tempSourceFile.createNewFile()) {</span>
<span class="nc" id="L149">                throw MavanagaiataMojoException.create(&quot;Could not create temporary file %s&quot;, null, tempSourceFile.getAbsolutePath());</span>
            }
<span class="fc" id="L151">            try (FileOutputStream tempSourceFileStream = new FileOutputStream(tempSourceFile)) {</span>
<span class="fc" id="L152">                IOUtils.copy(templateStream, tempSourceFileStream);</span>
            }

<span class="fc" id="L155">            return tempSourceFile;</span>
        }
    }

    MapBasedValueSource getValueSource(GitRepository repository)
            throws GitRepositoryException {
<span class="fc" id="L161">        GitTagDescription description = repository.describe();</span>

<span class="fc" id="L163">        String abbrevId  = repository.getAbbreviatedCommitId();</span>
<span class="fc" id="L164">        String shaId     = repository.getHeadCommit().getId();</span>
<span class="fc" id="L165">        String describe  = description.toString();</span>
<span class="fc" id="L166">        boolean isDirty  = repository.isDirty(dirtyIgnoreUntracked);</span>

<span class="fc bfc" id="L168" title="All 4 branches covered.">        if (isDirty &amp;&amp; dirtyFlag != null) {</span>
<span class="fc" id="L169">            abbrevId += dirtyFlag;</span>
<span class="fc" id="L170">            shaId    += dirtyFlag;</span>
<span class="fc" id="L171">            describe += dirtyFlag;</span>
        }

<span class="fc" id="L174">        HashMap&lt;String, String&gt; values = new HashMap&lt;&gt;();</span>
<span class="fc" id="L175">        values.put(&quot;BRANCH&quot;, repository.getBranch());</span>
<span class="fc" id="L176">        values.put(&quot;CLASS_NAME&quot;, className);</span>
<span class="fc" id="L177">        values.put(&quot;COMMIT_ABBREV&quot;, abbrevId);</span>
<span class="fc" id="L178">        values.put(&quot;COMMIT_SHA&quot;, shaId);</span>
<span class="fc" id="L179">        values.put(&quot;DESCRIBE&quot;, describe);</span>
<span class="fc" id="L180">        values.put(&quot;DIRTY&quot;, Boolean.toString(isDirty));</span>
<span class="fc" id="L181">        values.put(&quot;PACKAGE_NAME&quot;, packageName);</span>
<span class="fc" id="L182">        values.put(&quot;TAG_NAME&quot;, description.getNextTagName());</span>
<span class="fc" id="L183">        values.put(&quot;TIMESTAMP&quot;, new SimpleDateFormat(dateFormat).format(new Date()));</span>
<span class="fc" id="L184">        values.put(&quot;VERSION&quot;, project.getVersion());</span>

<span class="fc" id="L186">        String version = VersionHelper.getVersion();</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        if (version != null) {</span>
<span class="nc" id="L188">            values.put(&quot;MAVANAGAIATA_VERSION&quot;, version);</span>
        }

<span class="fc" id="L191">        return new MapBasedValueSource(values);</span>
    }

    private void writeSourceFile(GitRepository repository, File sourceFile)
            throws GitRepositoryException, MavanagaiataMojoException,
                   MavenFilteringException {
<span class="fc" id="L197">        File packageDirectory = new File(outputDirectory, packageName.replace('.', '/'));</span>
<span class="fc" id="L198">        File outputFile = new File(packageDirectory, sourceFile.getName());</span>

        try {
<span class="fc" id="L201">            deleteIfExists(outputFile.toPath());</span>
<span class="fc" id="L202">            createDirectories(packageDirectory.toPath());</span>

<span class="fc" id="L204">            List&lt;FilterWrapper&gt; filterWrappers = singletonList(new ValueSourceFilter(repository));</span>
<span class="fc" id="L205">            fileFilter.copyFile(sourceFile, outputFile, true, filterWrappers, encoding, true);</span>
<span class="nc" id="L206">        } catch (IOException e) {</span>
<span class="nc" id="L207">            throw MavanagaiataMojoException.create(&quot;Could not create class source: %s&quot;, e, outputFile.getAbsolutePath());</span>
<span class="fc" id="L208">        }</span>
<span class="fc" id="L209">    }</span>

    private class ValueSourceFilter extends FilterWrapper {
        private final MapBasedValueSource valueSource;

        ValueSourceFilter(GitRepository repository)
<span class="fc" id="L215">                throws GitRepositoryException {</span>
<span class="fc" id="L216">            valueSource = InfoClassMojo.this.getValueSource(repository);</span>
<span class="fc" id="L217">        }</span>

        @Override
        public Reader getReader(Reader fileReader) {
<span class="nc" id="L221">            RegexBasedInterpolator regexInterpolator = new RegexBasedInterpolator();</span>
<span class="nc" id="L222">            regexInterpolator.addValueSource(valueSource);</span>

<span class="nc" id="L224">            return new InterpolatorFilterReader(fileReader,  regexInterpolator);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>